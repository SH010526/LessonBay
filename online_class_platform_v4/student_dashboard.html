<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="수강 중인 클래스 관리 및 학습 현황을 확인하는 학생 대시보드입니다.">
    <meta name="theme-color" content="#4F46E5">
    <title>학생 대시보드 - LessonBay</title>

    <!-- Critical CSS Inline -->
    <style>
        /* Critical Path CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4F46E5;
            --secondary-color: #10B981;
            --light-bg: #F3F4F6;
            --dark-text: #1F2937;
            --border-color: #E5E7EB;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            color: inherit;
            background: #e5e7eb;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .course-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .course-item:hover {
            background-color: var(--light-bg);
        }

        .course-name {
            font-weight: 500;
        }

        .course-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background-color: #DCFCE7;
            color: var(--secondary-color);
        }

        .stat-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .footer {
            text-align: center;
            color: #9CA3AF;
            margin-top: 40px;
        }
    </style>

    <!-- Supabase & Global Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="script.js" defer></script>
</head>

<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo"> LessonBay</a>
            <div class="header-actions">
                <a href="classes.html" class="btn">수업 탐색</a>
                <button class="btn btn-primary" id="refreshBtn">새로고침</button>
                <a href="logout.html" class="btn">로그아웃</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="stats-container" id="statsContainer">
            <!-- Stats will load here -->
        </section>

        <div class="dashboard-grid" id="dashboardGrid">
            <div class="card" id="activeCoursesCard">
                <h3 class="card-title">수강 중인 수업</h3>
                <p class="card-content">불러오는 중...</p>
            </div>
            <div class="card" id="activityCard">
                <h3 class="card-title">학습 활동</h3>
                <p class="card-content">로딩 중...</p>
            </div>
        </div>

        <!-- Error Log Area for Debugging -->
        <div id="debugLog"
            style="margin-top: 20px; padding: 10px; background: #fffbe6; border: 1px solid #ffe58f; display: none; border-radius: 8px;">
            <h4>Debug Info</h4>
            <pre id="debugContent" style="font-size: 12px; overflow-x: auto;"></pre>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 LessonBay. All rights reserved. | 최종 확인: <time id="lastUpdated">-</time></p>
    </footer>

    <script>
        function log(msg, data = null) {
            console.log(msg, data);
            const debug = document.getElementById('debugLog');
            const content = document.getElementById('debugContent');
            if (debug && content) {
                // debug.style.display = 'block'; // Uncomment to show debug visible to user
                const time = new Date().toLocaleTimeString();
                content.textContent += `[${time}] ${msg}${data ? ' ' + JSON.stringify(data, null, 2) : ''}\n`;
            }
        }

        async function initializeDashboard() {
            try {
                if (typeof waitForSupabaseClient === 'function') {
                    await waitForSupabaseClient();
                }

                // Ensure we have a valid client instance
                if (!window.supabaseClient && window.supabase && window.supabase.createClient) {
                    const SUPABASE_URL = "https://pqvdexhxytahljultmjd.supabase.co";
                    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxdmRleGh4eXRhaGxqdWx0bWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjMzNTMsImV4cCI6MjA4MTUzOTM1M30.WzJWY3-92Bwkic-Wb2rOmZ1joEUj-s69cSL2hPT79fQ";
                    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
                }

                const client = window.supabaseClient;
                if (!client) throw new Error("Supabase Client not found");

                const { data: { session } } = await client.auth.getSession();
                const user = session?.user;

                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                log("User found", user.id);

                // Step 1: Get Enrollments (Usage of PascalCase 'Enrollment' and camelCase 'userId')
                const { data: enrollments, error: enrollError } = await client
                    .from('Enrollment')
                    .select('classId')
                    .eq('userId', user.id);

                if (enrollError) {
                    log("Enrollment Fetch Error", enrollError);
                    throw enrollError;
                }

                log("Enrollments fetched", enrollments);

                let courses = [];
                if (enrollments && enrollments.length > 0) {
                    const classIds = enrollments.map(e => e.classId);

                    // Step 2: Get Classes (Table 'Class')
                    const { data: classes, error: classError } = await client
                        .from('Class')
                        .select('*')
                        .in('id', classIds);

                    if (classError) {
                        log("Classes Fetch Error", classError);
                        // If error fetching classes, just show what we have or empty
                    } else {
                        log("Classes fetched", classes);
                        // Mapping to local courses object
                        courses = classes.map(c => ({
                            id: c.id,
                            name: c.title, // Assuming 'title' column exists. If Prisma, it might be 'title'.
                            progress: 0,
                            status: 'active'
                        }));
                    }
                }

                // Update Stats
                const stats = [
                    { number: courses.length, label: '수강 중인 수업' },
                    { number: '0%', label: '평균 진도율' }
                ];

                renderStats(stats);
                renderCourses(courses);
                renderActivities([]);
                updateLastUpdated();

            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                log("Fatal Error", error);

                // Show localized error
                const dashboard = document.getElementById('dashboardGrid');
                if (dashboard) {
                    dashboard.innerHTML = `
            <div class="card" style="grid-column: 1/-1; text-align: center; padding: 40px;">
              <h3 class="card-title">데이터를 불러오는 데 실패했습니다.</h3>
              <button class="btn btn-primary" onclick="location.reload();">다시 시도</button>
            </div>
          `;
                }
            }
        }

        function renderStats(stats) {
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) {
                statsContainer.innerHTML = stats.map(stat => `
          <div class="stat-box">
            <div class="stat-number">${stat.number}</div>
            <div class="stat-label">${stat.label}</div>
          </div>
        `).join('');
            }
        }

        function renderCourses(courses) {
            const activeCoursesCard = document.getElementById('activeCoursesCard');
            if (!activeCoursesCard) return;

            if (!courses || courses.length === 0) {
                activeCoursesCard.innerHTML = `
          <h3 class="card-title">수강 중인 수업</h3>
          <p class="card-content" style="padding: 10px 0;">수강 중인 수업이 없습니다. 새로운 수업을 찾아보세요!</p>
          <a href="classes.html" class="btn btn-primary">수업 탐색하기</a>
        `;
                return;
            }

            const courseListHTML = courses.map(course => `
        <div class="course-item" onclick="location.href='class_detail.html?id=${course.id}'">
          <span class="course-name">${course.name}</span>
          <span class="course-status">수강 중</span>
        </div>
      `).join('');

            activeCoursesCard.innerHTML = `
        <h3 class="card-title">수강 중인 수업</h3>
        <div class="course-list">
          ${courseListHTML}
        </div>
      `;
        }

        function renderActivities(activities) {
            const activityCard = document.getElementById('activityCard');
            if (!activityCard) return;

            if (!activities || activities.length === 0) {
                activityCard.innerHTML = `
          <h3 class="card-title">학습 활동</h3>
          <p class="card-content">학습 활동 내역이 아직 없습니다.</p>
        `;
                return;
            }
            // ... rendering logic ...
            activityCard.innerHTML = `<h3>최근 활동</h3><p>기록이 없습니다.</p>`;
        }

        function updateLastUpdated() {
            const el = document.getElementById('lastUpdated');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }

        document.getElementById('refreshBtn').addEventListener('click', initializeDashboard);

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }
    </script>
</body>

</html>