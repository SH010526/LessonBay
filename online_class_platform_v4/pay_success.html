<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²°ì œ ?„ë£Œ</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 560px; margin: 40px auto; padding: 20px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:18px; box-shadow:0 6px 16px rgba(0,0,0,0.08); }
    .muted { color:#6b7280; margin-top:8px; }
    button { padding:10px 16px; border:none; border-radius:8px; background:#6d5efc; color:#fff; cursor:pointer; }
    pre { background:#f4f4f5; padding:12px; border-radius:8px; font-size:13px; overflow:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ê²°ì œ ?•ì¸ ì¤?..</h2>
    <div id="msg" class="muted">? ì‹œë§?ê¸°ë‹¤?¤ì£¼?¸ìš”.</div>
    <pre id="log" style="display:none;"></pre>
    <div style="margin-top:14px;">
      <button id="goHome" style="display:none;">ë©”ì¸?¼ë¡œ ?´ë™</button>
    </div>
  </div>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const paymentKey = params.get("paymentKey");
      const orderId = params.get("orderId");
      const amount = params.get("amount");
      const classId = params.get("classId");
      const returnUrl = params.get("returnUrl") || `http://127.0.0.1:5500/online_class_platform_v4/class_detail.html?id=${encodeURIComponent(classId || "")}`;

      const msgEl = document.getElementById("msg");
      const logEl = document.getElementById("log");
      const goHome = document.getElementById("goHome");

      function setLog(obj) {
        logEl.style.display = "block";
        logEl.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }

      if (!paymentKey || !orderId || !amount) {
        msgEl.textContent = "?„ìˆ˜ ê²°ì œ ?•ë³´ê°€ ?†ìŠµ?ˆë‹¤.";
        setLog({ paymentKey, orderId, amount });
        goHome.style.display = "inline-block";
        goHome.onclick = () => location.href = returnUrl;
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/api/payments/confirm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentKey, orderId, amount })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "ê²°ì œ ?•ì¸ ?¤íŒ¨");

        // ?˜ê°• ?±ë¡???„ìš”???•ë³´ê°€ pending?¼ë¡œ ?€?¥ë˜???ˆìœ¼ë©?ë°˜ì˜
        try {
          const pendingRaw = localStorage.getItem("lc_pending_enroll");
          if (pendingRaw) {
            const pending = JSON.parse(pendingRaw);
            const { record, keys, classId: cid } = pending || {};
            if (record && keys && cid) {
              const enroll = JSON.parse(localStorage.getItem("lc_enrollments") || "{}");
              keys.forEach(k => {
                enroll[k] = enroll[k] || {};
                enroll[k][cid] = record;
              });
              localStorage.setItem("lc_enrollments", JSON.stringify(enroll));
            }
            localStorage.removeItem("lc_pending_enroll");
          }
        } catch (_) {}

        msgEl.textContent = "ê²°ì œê°€ ?„ë£Œ?˜ì—ˆ?µë‹ˆ?? ?˜ê°• ?±ë¡??ë°˜ì˜?˜ì—ˆ?µë‹ˆ??";
        setLog(data);
        goHome.style.display = "inline-block";
        goHome.onclick = () => location.href = returnUrl;
      } catch (e) {
        msgEl.textContent = e.message || "ê²°ì œ ì²˜ë¦¬???¤íŒ¨?ˆìŠµ?ˆë‹¤.";
        setLog(e);
        goHome.style.display = "inline-block";
        goHome.onclick = () => location.href = returnUrl;
      }
    })();
  </script>
</body>
</html>
